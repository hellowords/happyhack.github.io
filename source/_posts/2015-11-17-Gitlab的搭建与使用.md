---
title: Gitlab的搭建与使用。
tags:
  - Gitlab
id: 39
categories:
  - 胡说
date: 2015-11-17 15:51:54
update : 2016-10-23 04:04:00
---

![gitlab](http://offt6br14.bkt.clouddn.com/bolg/img/1_150707164216_1-300x201.jpg)

今天接到一个任务是在公司的服务器上搭建一个私有的代码版本控制系统。查阅了很多的资料，
因为是需要一个网站式的版本管理，所以最终选择了使用Gitlab。其实还可以使用本地的Github的。
下次有机会再练练手。先开始搭建Gitlab吧！Good luck！
首先学到了一个更新系统软件包的一个命令： apt-get -y upgrade
又学到了一个命令，删除一个系统用户的命令： userdel -r git 增加一个用户：`adduser git`

安装步骤：(**文末有Gitlab一键安装包**）
##更新系统##
```
apt-get update 
apt-get upgrade 
**安装依赖包（编译 Ruby 以及 Ruby gems 的本地扩展）**
sudo apt-get install -y build-essential zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libreadline-dev libncurses5-dev libffi-dev curl openssh-server redis-server checkinstall libxml2-dev libxslt-dev libcurl4-openssl-dev libicu-dev logrotate python-docutils pkg-config cmake libkrb5-dev
```
## 安装 Git##
```
sudo apt-get install -y git-core
```
需要版本在 1.7.10 以上 `git --version`

如果已经安装了旧版本的 Git， 可以移除然后从源码编译安装最新版本
`sudo apt-get remove git-core`
###安装依赖###
```
 sudo apt-get install -y libcurl4-openssl-dev libexpat1-dev gettext libz-dev libssl-dev build-essential
```
###下载及编译安装###
```
cd /tmp 
curl -L --progress https://www.kernel.org/pub/software/scm/git/git-2.1.2.tar.gz 
tar xz cd git-2.1.2/ 
./configure make prefix=/usr/local all 
sudo make prefix=/usr/local install
```
安装成功之后，需要在之后的 GitLab 配置文件中设置一下 Git 的执行路径 （/usr/local/bin/git）

##安装ruby##

```
mkdir /tmp/ruby
cd /tmp/ruby 
curl -L --progress http://cache.ruby-lang.org/pub/ruby/2.1/ruby-2.1.5.tar.gz  tar xz cd ruby-2.1.5 
./configure --disable-install-rdoc 
make 
sudo make install
```
**在这过程中编译的时候回出现错误，readline.c 出现错误。需要根据提示进行修改**！
将： `rl_pre_input_hook = (Function *)readline_pre_input_hook` 大概在1886行
修改：`rl_pre_input_hook = (rl_hook_func_t *)readline_pre_input_hook;`
编译成功之后还需要：
`gem install bundler --no-ri --no-rdoc`
这里也会出现错误，下面我贴上错误的解决办法！

是因为国内网络导致rubygems.org存放在Amazon S3上面的资源文件间歇性连接失败，用国内的RubyGems镜像(参见http://ruby.taobao.org/)替换官方镜像，方法如下：
```
gem sources --remove https://rubygems.org/ 
https://rubygems.org/ removed from sources
gem sources -a https://ruby.taobao.org/
https://ruby.taobao.org/ added to sources
gem sources -l
```
### CURRENT SOURCES ###

```
gem install bundler --no-ri --no-rdoc
```
###给系统添加一个git账号###

```
adduser --disabled-login --gecos 'GitLab' git
```
##安装数据库##
因为服务器已经有了数据库了，所以我就直接创建了相关库
```
CREATE DATABASE IF NOT EXISTS gitlabhq_production DEFAULT CHARACTER SET 'utf8' COLLATE 'utf8_unicode_ci'
```
###创建一个用户，用来控制相关的数据库：###
```
GRANT SELECT, LOCK TABLES, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON gitlabhq_production.* TO 'git'@'localhost' IDENTIFIED BY 'gitpwd'
```
##安装Redis##
（有一些配置我没有配置，只是安装了而已，重启之后要记得启动redis）**
sudo apt-get install redis-server
###Configure redis to use sockets##
```
sudo cp /etc/redis/redis.conf /etc/redis/redis.conf.orig
```
###Disable Redis###

listening on TCP by setting 'port' to 0 sed 's/^port .*/port 0/'
/etc/redis/redis.conf.orig | sudo tee /etc/redis/redis.conf
###Enable Redis###
socket for default Debian / Ubuntu path echo 'unixsocket
/var/run/redis/redis.sock' | sudo tee -a /etc/redis/redis.conf

###Grant permission to the socket to all members of the redis group###

```
echo 'unixsocketperm 770' | sudo tee -a /etc/redis/redis.conf
```
### Create the directory which contains the socket ###
```
mkdir /var/run/redis chown redis:redis /var/run/redis chmod 755 /var/run/redis
```
###Persist###
the directory which contains the socket, if applicable if [ -d /etc/tmpfiles.d ]; then

echo 'd /var/run/redis 0755 redis redis 10d -' | sudo tee -a /etc/tmpfiles.d/redis.conf fi

### Activate the changes to redis.conf ###
sudo service redis-server restart
### Add git to the redis group ###
```
sudo usermod -aG redis git
```
##安装 GitLab##
```
cd /home/git
git clone https://gitlab.com/gitlab-org/gitlab-ce.git -b 7-8-stable gitlab
```
###修改配置文件###
```
cp config/gitlab.yml.example /config/gitlab.yml
```
###给文件夹添加相应的权限###
```
chown -R git log/
chown -R git tmp/
chown -R u+rwX log/
chown -R u+rwX tmp/
chown -R u+rwX tmp/pids/
chown -R u+rwX tmp/sockets/
chown -R u+rwX public/uploads/
```
###创建目录，并赋予相应的权限###
```
mkdir /home/git/gitlab-satellites
chown u+rwx ,g=rx,o-rxw /home/git/gitlab_satellites
```
### 编辑配置文件 ###
```
cp config/unicorn.rb.example config/unicorn.rb
vim config/unicorn.rb
worker_processes XXX // CPU 核数
```
**在这里需要修改一下源，因为国内这体制。。。**
`gem soucrces -l`
**这里一定要删除一个源，只能留一个！**
`gem source -r https://rubygems.org`

**如果你看到这里，我很抱歉的告诉你，我用以上方法之后**然并卵*！也许是我接下来说的问题导致的吧**

按照以上这些步骤我也不知道为什么，在搭建到最后配置nginx的时候，一直不成功，网站访问
不了，有可能有是我在搭建的过程中有一些错误吧，不过在我折腾了好几天之后终于用
一键安装包终于搭好了，尼玛，一键安装包也折腾了好久（一天的时间！）
这里记录一下我在这几天的搭建过程中所遇到的问题和所学到的东西吧！
首先我的一个错误就是IP地址的问题，在访问的IP时候我访问的是公网的IP，这其实应该是
局域网的IP的，我一只拿公网的IP折腾，绝逼打不开啊!
在这过程中我也顺便学会了用nginx代理两个以上的网站，就是在添加一个server段就ok了
当让前提是要让一个端口打开，哈哈，我会了这个之后我突然觉得我可以在公司的服务器上搭建我自己的博客了，以后来试试!
在这之中还要记住的一个是端口问题,我用一键安装包的时候遇到的问题就是这个东东,服务器的相应端口没有打开,导致我一只访问不了,我一直以为是我的搭建有问题呢!今早终于成功了!
查看一个端口的: `lsof -i:80`
若要杀死一个占用端口的进程： kill 进程ID
查看已开服务： `netstat`
-a (all)显示所有选项，默认不显示LISTEN相关
-t (tcp)仅显示tcp相关选项
-u (udp)仅显示udp相关选项
-n 拒绝显示别名，能显示数字的全部转化成数字。
-l 仅列出有在 Listen (监听) 的服務状态
-p 显示建立相关链接的程序名
-r 显示路由信息，路由表
-e 显示扩展信息，例如uid等
-s 按各个协议进行统计
-c 每隔一个固定时间，执行该netstat命令。
提示：LISTEN和LISTENING的状态只有用-a或者-l才能看到
这其中需要用防火墙的一个功能在打开或者关闭一个端口。
ibtables防火墙： ufw（笔记其他地方有记载）

下面给出gitlab的一键安装的过程中需要注意的地方。
Gitlab一键安装包下载地址： https://bitnami.com/stack/gitlab
下载之后需要添加一个执行权限： `chmod +x /XXXXX`
到所在目录执行这个文件： ./XXXX
接下来的安装就相对来说比较的简单了，不过在安装的过程中有要陪邮件服务器的步骤，这次的配置我直接略过了，下次有机会的时候在配置的时候在添加！
2015/11/12 13:41